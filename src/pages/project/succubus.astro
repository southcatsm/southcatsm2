---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import MainCard from "@/components/MainCard.astro";
---

<BaseLayout title="功能·魅魔">
	<style>
		.alert {
		    position: fixed;
						width: 230px;
						height: 40px;
		    top: 20px;
		    right: -100%;
		    background: #ff4444;
		    color: white;
		    padding: 12px 18px;
		    border-radius: 6px;
		    display: flex;
		    align-items: center;
		    opacity: 0;
		    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		    box-shadow: 0 3px 6px rgba(0,0,0,0.16);
		    font-family: Arial, sans-serif;
		}
		
		.alert.show {
		    opacity: 1;
		    right: 20px;
		}
		
		.icon::before {
		    content: "×";
		    display: inline-block;
		    width: 18px;
		    height: 18px;
		    border-radius: 50%;
		    background: white;
		    color: #ff4444;
		    text-align: center;
		    line-height: 18px;
		    margin-right: 12px;
		    font-weight: 700;
		    font-size: 14px;
		}
	</style>
	<MainCard>
		<div id="staticAlert" class="alert">
		    <span class="icon"></span>
		    <span class="message">名字不能留空</span>
		</div>
		<h1 class="font-bold text-center mb-4 text-3xl text-purple-400">
			没墨生成器
		</h1>
		<div style="text-align: center;">
			<input
			  type="text"
			  placeholder="请输入您的名称"
			  class="input input-bordered pl-10 pr-16 py-2 border-dashed border-teal-500 hover:border-slate-400 "
			  id="search"
			/>
		</div>
		<br/>
		<MainCard>
			<div class="text-center" id="basicInfo"></div>
			<br/>
			<div style="text-align: center;">
				<div id="smpie"></div>
			</div>
		</MainCard>
		<div class="divider my-8">
			<Icon name="lucide:heart-pulse" class="w-10 h-10 text-primary" />
			<strong>仅供娱乐，切勿代入！</strong>
		</div>
		<script src="https://cdn.jsdelivr.net/gh/daeroa/nrcdn2/js/echarts.js" type="text/javascript"></script>
		<script>
  // @ts-ignore 忽略 TS 对 CDN 模块的类型检查
  import { divine } from "https://cdn.jsdelivr.net/gh/daeroa/nrcdn2@1.45/js/sakyubasu.js";

  // 让 TS 知道 echarts 是全局变量
  declare var echarts: any;

  const crt = document.documentElement.getAttribute("data-theme");
  document.getElementById('staticAlert')?.classList.remove('show');

  let hideTimer: ReturnType<typeof setTimeout> | null = null;

  function showAlert() {
    const alertEl = document.getElementById('staticAlert');
    if (!alertEl) return;
    clearTimeout(hideTimer!);
    alertEl.classList.add('show');
    hideTimer = setTimeout(() => {
      alertEl.classList.remove('show');
    }, 2000);
  }

  document.querySelector("#search")?.addEventListener("keydown", (e: KeyboardEvent) => {
    const input = document.getElementById("search") as HTMLInputElement;
    const name = input.value;
    
    if (e.key === "Enter") {
      if (name.length === 0) {
        showAlert();
        return;
      }

      const result = divine(name);
      const smpie = document.getElementById("smpie");
      if (!smpie) return;

      document.getElementById("basicInfo")!.innerHTML = Object.entries(result).slice(0,14).map(([k, v]) => `<p><strong>${k}</strong>：${v}</p>`).join('');
      smpie.style.height = "400px";
      smpie.style.width = "400px";
      if (crt === "dracula") smpie.style.background = "#927974";

      const pie = echarts.init(smpie);
      const pieOption = {
        title: {
          text: `${result["姓名"]}のSM程度`,
          subtext: "by Southcatsm",
          left: "center"
        },
        tooltip: { trigger: 'item' },
        legend: { orient: 'vertical', left: 'left' },
        series: [{
          name: "SM程度",
          type: 'pie',
          radius: '55%',
          data: [
            { value: result["S度"], name: 'S程度' },
            { value: result["M度"], name: 'M程度' }
          ],
          itemStyle: {
            shadowBlur: 200,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }]
      };
      pie.setOption(pieOption);
    }
  });
</script>
	</MainCard>
</BaseLayout>
	